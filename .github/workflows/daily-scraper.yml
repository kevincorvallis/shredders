name: Daily Mountain Scraper

on:
  schedule:
    # Run at 6 AM and 6 PM UTC (10 PM and 10 AM PST)
    # Batch 1 at :00, Batch 2 at :02, Batch 3 at :04
    - cron: '0 6,18 * * *'

  # Allow manual triggering from GitHub UI
  workflow_dispatch:
    inputs:
      batch:
        description: 'Batch to scrape (1, 2, 3, or all)'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - '1'
          - '2'
          - '3'

jobs:
  scrape-batch-1:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event.inputs.batch == 'all' || github.event.inputs.batch == '1'

    steps:
      - name: Scrape Batch 1 (WA Cascades)
        run: |
          echo "üèîÔ∏è Scraping Batch 1: Baker, Stevens, Crystal, Snoqualmie, Whitepass..."

          response=$(curl -s -w "\n%{http_code}" \
            -X GET \
            -H "Content-Type: application/json" \
            "${{ secrets.APP_URL }}/api/scraper/run?batch=1")

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')

          echo "Response Code: $http_code"
          echo "Response Body: $body"

          if [ "$http_code" -eq 200 ]; then
            echo "‚úÖ Batch 1 completed successfully"
            successful=$(echo "$body" | grep -o '"successful":[0-9]*' | grep -o '[0-9]*')
            failed=$(echo "$body" | grep -o '"failed":[0-9]*' | grep -o '[0-9]*')
            echo "üìä Results: $successful successful, $failed failed"
          else
            echo "‚ùå Batch 1 failed with status $http_code"
            exit 1
          fi

  scrape-batch-2:
    runs-on: ubuntu-latest
    needs: scrape-batch-1
    if: always() && (github.event_name == 'schedule' || github.event.inputs.batch == 'all' || github.event.inputs.batch == '2')

    steps:
      - name: Scrape Batch 2 (Oregon + Eastern WA)
        run: |
          echo "üèîÔ∏è Scraping Batch 2: Meadows, Timberline, Bachelor, Mission Ridge, 49 North..."

          response=$(curl -s -w "\n%{http_code}" \
            -X GET \
            -H "Content-Type: application/json" \
            "${{ secrets.APP_URL }}/api/scraper/run?batch=2")

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')

          echo "Response Code: $http_code"
          echo "Response Body: $body"

          if [ "$http_code" -eq 200 ]; then
            echo "‚úÖ Batch 2 completed successfully"
            successful=$(echo "$body" | grep -o '"successful":[0-9]*' | grep -o '[0-9]*')
            failed=$(echo "$body" | grep -o '"failed":[0-9]*' | grep -o '[0-9]*')
            echo "üìä Results: $successful successful, $failed failed"
          else
            echo "‚ùå Batch 2 failed with status $http_code"
            exit 1
          fi

  scrape-batch-3:
    runs-on: ubuntu-latest
    needs: scrape-batch-2
    if: always() && (github.event_name == 'schedule' || github.event.inputs.batch == 'all' || github.event.inputs.batch == '3')

    steps:
      - name: Scrape Batch 3 (Idaho + Southern Oregon)
        run: |
          echo "üèîÔ∏è Scraping Batch 3: Schweitzer, Lookout, Ashland, Willamette, Hoodoo..."

          response=$(curl -s -w "\n%{http_code}" \
            -X GET \
            -H "Content-Type: application/json" \
            "${{ secrets.APP_URL }}/api/scraper/run?batch=3")

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')

          echo "Response Code: $http_code"
          echo "Response Body: $body"

          if [ "$http_code" -eq 200 ]; then
            echo "‚úÖ Batch 3 completed successfully"
            successful=$(echo "$body" | grep -o '"successful":[0-9]*' | grep -o '[0-9]*')
            failed=$(echo "$body" | grep -o '"failed":[0-9]*' | grep -o '[0-9]*')
            echo "üìä Results: $successful successful, $failed failed"
          else
            echo "‚ùå Batch 3 failed with status $http_code"
            exit 1
          fi

  notify-on-failure:
    runs-on: ubuntu-latest
    needs: [scrape-batch-1, scrape-batch-2, scrape-batch-3]
    if: failure()

    steps:
      - name: Send Failure Notification
        run: |
          echo "‚ùå Mountain scraper failed. Check logs for details."
          # Add Slack/Discord notification here if desired
